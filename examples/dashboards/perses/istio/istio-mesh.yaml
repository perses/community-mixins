kind: Dashboard
metadata:
    name: istio-mesh
    createdAt: 0001-01-01T00:00:00Z
    updatedAt: 0001-01-01T00:00:00Z
    version: 0
    project: perses-dev
spec:
    display:
        name: Istio Mesh Dashboard
    panels:
        "0_0":
            kind: Panel
            spec:
                display:
                    name: Traffic Volume
                    description: Total requests in the cluster
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: requests/sec
                        thresholds:
                            mode: absolute
                            defaultColor: green
                            steps:
                                - value: 0
                                  color: green
                                - value: 80
                                  color: red
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: round(sum(rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])), 0.01)
        "0_1":
            kind: Panel
            spec:
                display:
                    name: Success Rate
                    description: Total success rate of requests in the cluster
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: percent-decimal
                        thresholds:
                            mode: absolute
                            defaultColor: green
                            steps:
                                - value: 0
                                  color: green
                                - value: 80
                                  color: red
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      sum(rate(istio_requests_total{reporter=~"source|waypoint",response_code!~"5.."}[$__rate_interval]))
                                    /
                                      sum(rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval]))
        "0_2":
            kind: Panel
            spec:
                display:
                    name: 4xxs
                    description: Total 4xx requests in in the cluster
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: requests/sec
                        thresholds:
                            mode: absolute
                            defaultColor: green
                            steps:
                                - value: 0
                                  color: green
                                - value: 80
                                  color: red
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      round(
                                        sum(rate(istio_requests_total{reporter=~"source|waypoint",response_code=~"4.."}[$__rate_interval])),
                                        0.01
                                      )
                                    or
                                      vector(0)
        "0_3":
            kind: Panel
            spec:
                display:
                    name: 5xxs
                    description: Total 5xx requests in in the cluster
                plugin:
                    kind: StatChart
                    spec:
                        calculation: last
                        format:
                            unit: requests/sec
                        thresholds:
                            mode: absolute
                            defaultColor: green
                            steps:
                                - value: 0
                                  color: green
                                - value: 80
                                  color: red
                        sparkline:
                            width: 1
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |4-
                                      round(
                                        sum(rate(istio_requests_total{reporter=~"source|waypoint",response_code=~"5.."}[$__rate_interval])),
                                        0.01
                                      )
                                    or
                                      vector(0)
        "1_0":
            kind: Panel
            spec:
                display:
                    name: HTTP/gRPC Workloads
                    description: Request information for HTTP services
                plugin:
                    kind: Table
                    spec:
                        columnSettings:
                            - name: 'Value #requests'
                              header: Requests
                            - name: 'Value #p50'
                              header: P50 Latency
                            - name: 'Value #p90'
                              header: P90 Latency
                            - name: 'Value #p99'
                              header: P99 Latency
                            - name: 'Value #success'
                              header: Success Rate
                            - name: destination_workload_var
                              header: Workload
                            - name: destination_service
                              header: Service
                            - name: destination_workload_namespace
                            - name: destination_workload
                            - name: timestamp
                        transforms:
                            - kind: MergeSeries
                              spec: {}
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                      sum by (destination_workload, destination_workload_namespace, destination_service) (
                                        rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])
                                      ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                      histogram_quantile(
                                        0.5,
                                        sum by (le, destination_workload, destination_workload_namespace) (
                                          rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval])
                                        )
                                      ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                      histogram_quantile(
                                        0.9,
                                        sum by (le, destination_workload, destination_workload_namespace) (
                                          rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval])
                                        )
                                      ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                      histogram_quantile(
                                        0.99,
                                        sum by (le, destination_workload, destination_workload_namespace) (
                                          rate(istio_request_duration_milliseconds_bucket{reporter=~"source|waypoint"}[$__rate_interval])
                                        )
                                      ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                        sum by (destination_workload, destination_workload_namespace) (
                                          rate(istio_requests_total{reporter=~"source|waypoint",response_code!~"5.."}[$__rate_interval])
                                        )
                                      /
                                        sum by (destination_workload, destination_workload_namespace) (
                                          rate(istio_requests_total{reporter=~"source|waypoint"}[$__rate_interval])
                                        ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
        "1_1":
            kind: Panel
            spec:
                display:
                    name: TCP Workloads
                    description: Bytes sent and recieived information for TCP services
                plugin:
                    kind: Table
                    spec:
                        columnSettings:
                            - name: 'Value #recv'
                              header: Bytes Received
                            - name: 'Value #sent'
                              header: Bytes Sent
                            - name: destination_workload_var
                              header: Workload
                            - name: destination_service
                              header: Service
                            - name: destination_workload_namespace
                            - name: destination_workload
                            - name: timestamp
                        transforms:
                            - kind: MergeSeries
                              spec: {}
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                      sum by (destination_workload, destination_workload_namespace, destination_service) (
                                        rate(istio_tcp_received_bytes_total{reporter=~"source|waypoint"}[$__rate_interval])
                                      ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: |-
                                    label_join(
                                      sum by (destination_workload, destination_workload_namespace, destination_service) (
                                        rate(istio_tcp_sent_bytes_total{reporter=~"source|waypoint"}[$__rate_interval])
                                      ),
                                      "destination_workload_var",
                                      ".",
                                      "destination_workload",
                                      "destination_workload_namespace"
                                    )
                                seriesNameFormat: '{{ destination_workload}}.{{ destination_workload_namespace }}'
        "2_0":
            kind: Panel
            spec:
                display:
                    name: Istio Component Versions
                    description: Version number of each running instance
                plugin:
                    kind: TimeSeriesChart
                    spec:
                        legend:
                            position: bottom
                            mode: list
                        visual:
                            display: line
                            lineWidth: 1
                            areaOpacity: 0.1
                            palette:
                                mode: auto
                queries:
                    - kind: TimeSeriesQuery
                      spec:
                        plugin:
                            kind: PrometheusTimeSeriesQuery
                            spec:
                                datasource:
                                    kind: PrometheusDatasource
                                    name: prometheus-datasource
                                query: sum by (component, tag) (istio_build)
                                seriesNameFormat: '{{component}} ({{tag}})'
    layouts:
        - kind: Grid
          spec:
            display:
                title: Global Traffic
            items:
                - x: 0
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_0'
                - x: 6
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_1'
                - x: 12
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_2'
                - x: 18
                  "y": 0
                  width: 6
                  height: 6
                  content:
                    $ref: '#/spec/panels/0_3'
        - kind: Grid
          spec:
            display:
                title: Global Traffic
            items:
                - x: 0
                  "y": 0
                  width: 24
                  height: 16
                  content:
                    $ref: '#/spec/panels/1_0'
                - x: 0
                  "y": 16
                  width: 24
                  height: 16
                  content:
                    $ref: '#/spec/panels/1_1'
        - kind: Grid
          spec:
            display:
                title: Istio Component Versions
            items:
                - x: 0
                  "y": 0
                  width: 24
                  height: 8
                  content:
                    $ref: '#/spec/panels/2_0'
    duration: 1h
